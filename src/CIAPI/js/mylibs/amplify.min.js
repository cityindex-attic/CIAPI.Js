/*!
 * Amplify 1.0beta - Core, Store, Request
 * 
 * Copyright 2011 appendTo LLC. (http://appendto.com/team)
 * Dual licensed under the MIT or GPL licenses.
 * http://appendto.com/open-source-licenses
 * 
 * http://amplifyjs.com
 */
(function(a,b){var c=[].slice,d={},e=a.amplify={publish:function(a){var b=c.call(arguments,1),e,f,g=0,h;if(!d[a])return!0;for(f=d[a].length;g<f;g++){e=d[a][g],h=e.callback.apply(e.context,b);if(h===!1)break}return h!==!1},subscribe:function(a,b,c,e){arguments.length===3&&typeof c=="number"&&(e=c,c=b,b=null),arguments.length===2&&(c=b,b=null),e=e||10,d[a]||(d[a]=[]);var f=d[a].length-1,g={callback:c,context:b,priority:e};for(;f>=0;f--)if(d[a][f].priority<=e){d[a].splice(f+1,0,g);return c}d[a].unshift(g);return c},unsubscribe:function(a,b){if(!!d[a]){var c=d[a].length,e=0;for(;e<c;e++)if(d[a][e].callback===b){d[a].splice(e,1);break}}}}})(this),function(a,b){function d(a,d){function f(a){d.removeItem?d.removeItem(a):delete d[a],delete e[a]}var e=d.__amplify__?JSON.parse(d.__amplify__):{};c.addType(a,function(g,h,i){var j=h,k=(new Date).getTime(),l,m;if(!g){j={};for(g in e)l=d[g],m=l?JSON.parse(l):{expires:-1},m.expires&&m.expires<=k?f(g):j[g.replace(/^__amplify__/,"")]=m.data;d.__amplify__=JSON.stringify(e);return j}g="__amplify__"+g;if(h===b){if(e[g]){l=d[g],m=l?JSON.parse(l):{expires:-1};if(m.expires&&m.expires<=k)f(g);else return m.data}}else if(h===null)f(g);else{m=JSON.stringify({data:h,expires:i.expires?k+i.expires:null});try{d[g]=m,e[g]=!0}catch(n){c[a]();try{d[g]=m,e[g]=!0}catch(n){throw c.error()}}}d.__amplify__=JSON.stringify(e);return j})}var c=a.store=function(a,b,d,e){var e=c.type;d&&d.type&&d.type in c.types&&(e=d.type);return c.types[e](a,b,d||{})};c.types={},c.type=null,c.addType=function(a,b){c.type||(c.type=a),c.types[a]=b,c[a]=function(b,d,e){e=e||{},e.type=a;return c(b,d,e)}},c.error=function(){return"amplify.store quota exceeded"};for(var e in{localStorage:1,sessionStorage:1})try{window[e].getItem&&d(e,window[e])}catch(f){}if(window.globalStorage)try{d("globalStorage",window.globalStorage[window.location.hostname]),c.type==="sessionStorage"&&(c.type="globalStorage")}catch(f){}(function(){var a=document.createElement("div"),d="amplify",e;a.style.display="none",document.getElementsByTagName("head")[0].appendChild(a),a.addBehavior&&(a.addBehavior("#default#userdata"),a.load(d),e=a.getAttribute(d)?JSON.parse(a.getAttribute(d)):{},c.addType("userData",function(f,g,h){var i=g,j=(new Date).getTime(),k,l,m;if(!f){i={};for(f in e)k=a.getAttribute(f),l=k?JSON.parse(k):{expires:-1},l.expires&&l.expires<=j?(a.removeAttribute(f),delete e[f]):i[f]=l.data;a.setAttribute(d,JSON.stringify(e)),a.save(d);return i}f=f.replace(/[^-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u37f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-");if(g===b){if(f in e){k=a.getAttribute(f),l=k?JSON.parse(k):{expires:-1};if(l.expires&&l.expires<=j)a.removeAttribute(f),delete e[f];else return l.data}}else g===null?(a.removeAttribute(f),delete e[f]):(m=a.getAttribute(f),l=JSON.stringify({data:g,expires:h.expires?j+h.expires:null}),a.setAttribute(f,l),e[f]=!0);a.setAttribute(d,JSON.stringify(e));try{a.save(d)}catch(n){m===null?(a.removeAttribute(f),delete e[f]):a.setAttribute(f,m),c.userData();try{a.setAttribute(f,l),e[f]=!0,a.save(d)}catch(n){m===null?(a.removeAttribute(f),delete e[f]):a.setAttribute(f,m);throw c.error()}}return i}))})(),d("memory",{})}(this.amplify=this.amplify||{}),function(a,b){function d(a){return{}.toString.call(a)==="[object Function]"}function c(){}a.request=function(b,e,f){var g=b||{};typeof g=="string"&&(d(e)&&(f=e,e={}),g={resourceId:b,data:e||{},success:f});var h={abort:c},i=a.request.resources[g.resourceId],j=g.success||c,k=g.error||c;g.success=function(b,c){c=c||"success",a.publish("request.success",g,b,c),a.publish("request.complete",g,b,c),j(b,c)},g.error=function(b,c){c=c||"error",a.publish("request.error",g,b,c),a.publish("request.complete",g,b,c),k(b,c)};if(!i){if(!g.resourceId)throw"amplify.request: no resourceId provided";throw"amplify.request: unknown resourceId: "+g.resourceId}if(!a.publish("request.before",g))g.error(null,"abort");else{a.request.resources[g.resourceId](g,h);return h}},a.request.types={},a.request.resources={},a.request.define=function(b,c,d){if(typeof c=="string"){if(!(c in a.request.types))throw"amplify.request.define: unknown type: "+c;d.resourceId=b,a.request.resources[b]=a.request.types[c](d)}else a.request.resources[b]=c}}(amplify),function(a,b,c){var d=["status","statusText","responseText","responseXML","readyState"];a.request.types.ajax=function(e){e=b.extend({type:"GET"},e);return function(f,g){function p(a,e){b.each(d,function(a,b){try{o[b]=i[b]}catch(c){}}),o.statusText==="OK"&&(o.statusText="success"),a===c&&(a=null),n&&(e="abort"),/timeout|error|abort/.test(e)?o.error(a,e):o.success(a,e),p=b.noop}var h,i,j=e.url,k=f.data,l=g.abort,m={},n=!1,o={readyState:0,setRequestHeader:function(a,b){return i.setRequestHeader(a,b)},getAllResponseHeaders:function(){return i.getAllResponseHeaders()},getResponseHeader:function(a){return i.getResponseHeader(a)},overrideMimeType:function(a){return i.overrideMideType(a)},abort:function(){n=!0;try{i.abort()}catch(a){}p(null,"abort")},success:function(a,b){f.success(a,b)},error:function(a,b){f.error(a,b)}};typeof k!="string"&&(k=b.extend(!0,{},e.data,k),b.each(k,function(a,b){h=new RegExp("{"+a+"}","g"),h.test(j)&&(j=j.replace(h,b),delete k[a])})),b.extend(m,e,{url:j,type:e.type,data:k,dataType:e.dataType,success:function(a,b){p(a,b)},error:function(a,b){p(null,b)},beforeSend:function(b,c){i=b,m=c;var d=e.beforeSend?e.beforeSend.call(this,o,m):!0;return d&&a.publish("request.before.ajax",e,f,m,o)}}),b.ajax(m),g.abort=function(){o.abort(),l.call(this)}}};var e=a.request.cache={_key:function(a,b,c){function g(){return c.charCodeAt(e++)<<24|c.charCodeAt(e++)<<16|c.charCodeAt(e++)<<8|c.charCodeAt(e++)<<0}c=b+c;var d=c.length,e=0,f=g();while(e<d)f^=g();return"request-"+a+"-"+f},_default:function(){var a={};return function(b,c,d,f){var g=e._key(c.resourceId,d.url,d.data),h=b.cache;if(g in a){f.success(a[g]);return!1}var i=f.success;f.success=function(b){a[g]=b,typeof h=="number"&&setTimeout(function(){delete a[g]},h),i.apply(this,arguments)}}}()};a.store&&(b.each(a.store.types,function(b){e[b]=function(c,d,f,g){var h=e._key(d.resourceId,f.url,f.data),i=a.store[b](h);if(i){f.success(i);return!1}var j=g.success;g.success=function(d){a.store[b](h,d,{expires:c.cache.expires}),j.apply(this,arguments)}}}),e.persist=e[a.store.type]),a.subscribe("request.before.ajax",function(a){var b=a.cache;if(b){b=b.type||b;return e[b in e?b:"_default"].apply(this,arguments)}}),a.request.decoders={jsend:function(a,b,c,d,e){a.status==="success"?d(a.data):a.status==="fail"?e(a.data,"fail"):a.status==="error"&&(delete a.status,e(a,"error"))}},a.subscribe("request.before.ajax",function(c,d,e,f){function k(a,b){h(a,b)}function j(a,b){g(a,b)}var g=f.success,h=f.error,i=b.isFunction(c.decoder)?c.decoder:c.decoder in a.request.decoders?a.request.decoders[c.decoder]:a.request.decoders._default;!i||(f.success=function(a,b){i(a,b,f,j,k)},f.error=function(a,b){i(a,b,f,j,k)})})}(amplify,jQuery)